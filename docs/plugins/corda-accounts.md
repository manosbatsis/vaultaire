
# Corda Accounts Plugin

This plugin provides support for Corda Accounts to Vaultaire's runtime and build-time modules.

## Installation

Add Vaultaire's plugin for Corda Accounts to your Cordapp's Gradle dependencies
using compile, cordapp or cordaCompile to match the core Vaultaire dependency.

```groovy
cordaCompile "com.github.manosbatsis.vaultaire:vaultaire-plugin-accounts:$vaultaire_version"
```
Depending on the above dependency type, you may also need to add the plugin
to your client app and `deployNodes` dependency configuration.

## Features

The plugin adds both new and enhanced versions of core component types. It also overrides Vaultaire's
internal configuration options to effectively apply them. These include the default base types extended
by components generated by the annotation processor.

### DTO Enhancements

#### VaultaireAccountInfo Annotation

The plugin introduces the `VaultaireAccountInfo` annotation as the means to mark participant
or other properties of a `ContractState` that map to a Corda Account. Supported types include:

- `AbstractParty`
- `AnonymousParty`
- `PublicKey`
- `AccountParty`

Using the annotation for the last one is optional.

#### Accounts-Aware DTO Types

The plugin also adds:

- `AccountInfoDto` as a convenient model that maps from app-level users
or state properties (as supported by `@VaultaireAccountInfo` above) to Corda Accounts,
i.e. `AccountInfo` states.

- `VaultaireAccountsAwareLiteDto` as the replacement of `VaultaireLiteDto`,
including it's use as the base DTO type by the "lite" DTO strategy.

All the above effectively provide the "lite" DTO strategy with enhanced DTO<->state conversion
and patching utilities, i.e. mainly with support for mapping between the applicable types
(see `@VaultaireAccountInfo`) and `AccountInfoDto`.

As an example, consider the following state:

```kotlin
data class MagazineState(
        val publisher: AccountParty,
        @VaultaireAccountInfo
        val author: PublicKey,
        @VaultaireAccountInfo
        val editor: AbstractParty,
        //...
        override val linearId: UniqueIdentifier = UniqueIdentifier()
) : LinearState, QueryableState {
        override val participants get() = listOf(publisher.party, AbstractParty(author), editor)
        //...
}
```

The generated DTO for the above:

```kotlin
data class MagazineStateLiteDto(
		var publisher: AccountParty? = null,
		var author: AccountParty? = null,
		var editor: AccountNParty? = null,
		//...
		var linearId: UniqueIdentifier? = null
) : VaultaireAccountsAwareLiteDto<BookContract.MagazineState> {
```


### Query DSL Enhancements

TODO: support for account external IDs

### Service Enhancements

The plugin also adds and applies various accounts-aware service types as replacements
of their default equivalents.

```kotlin
// Create an instance of the generated service type,
// passing a ServiceHub, CordaRPCOps, NodeRpcConnection
// or even a custom StateServiceDelegate
val bookStateService = BookStateService(serviceHub)

// Get the account that is already stored locally
// and matching the given [id] if found, null otherwise
val accountOrNull: AccountInfo? = bookStateService.findStoredAccount(accountId)

// Get the account that is already stored locally
// and matching the given [id] if found, null otherwise
val account: AccountInfo = bookStateService.getStoredAccount(accountId)

// Find accounts that are already stored locally
// and match the given [criteria]
val accountsPage: Vault.Page<AccountInfo> =
	bookStateService.findStoredAccounts(queryCriteria)

// Create a public key for the given [accountInfo] */
val anonymousParty = bookStateService.createPublicKey(accountInfo)
```



